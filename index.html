<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangGraph News Frames Visualizer</title>
    <!-- Cytoscape.js via CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <!-- Optional: Layout extension like Dagre for better DAGs -->
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

    <style>
        body { /* ... existing styles ... */ }
        .container { /* ... existing styles ... */ }
        h1, h2, h3 { /* ... existing styles ... */ }
        .input-area, textarea, button { /* ... existing styles ... */ }
        .loader, @keyframes spin { /* ... existing styles ... */ }
        .message, .error, .warning, .success { /* ... existing styles ... */ }

        /* Graph Visualization Area */
        .graph-visualization-area {
            margin-top: 30px;
            display: none; /* Hidden initially */
        }

        /* Cytoscape Container */
        #cy-graph {
            width: 100%;
            height: 400px; /* Adjust as needed */
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .node-details-area { /* ... existing styles ... */ }
        .node-details-area h3 { /* ... existing styles ... */ }
        .node-details-area pre { /* ... existing styles ... */ }
        .final-output-area { /* ... existing styles ... */ }
        .final-output-area h3 { /* ... existing styles ... */ }
        .final-output-area p { /* ... existing styles ... */ }
    </style>
</head>
<body>
    <div class="container">
        <h1>LangGraph News Frames Visualizer</h1>

        <div class="input-area">
            <textarea id="headline-input" placeholder="Enter a news headline here..." rows="3"></textarea>
            <button id="generate-btn">Analyze with LangGraph</button>
        </div>

        <div id="loader" class="loader"></div>
        <div id="error-message" class="message error"></div>
        <div id="status-message" class="message"></div>

        <div class="graph-visualization-area" id="graph-viz-area">
            <h2>Graph Execution Flow</h2>
            <div id="cy-graph"></div> {/* Cytoscape renders here */}

            <div class="node-details-area" id="node-details">
                <h3>Node Details</h3>
                <p>Click on a node in the graph to see its output.</p>
                <pre id="node-output-pre">{}</pre>
            </div>

            <div class="final-output-area" id="final-output">
                <h3>Final Flipped Headline</h3>
                <p id="flipped-headline-text">Pending analysis...</p>
                <p id="db-save-status-text"></p>
            </div>
        </div>
    </div>

    <script>
        const headlineInput = document.getElementById('headline-input');
        const generateBtn = document.getElementById('generate-btn');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const statusMessage = document.getElementById('status-message');

        const graphVizArea = document.getElementById('graph-viz-area');
        const nodeDetailsContainer = document.getElementById('node-details');
        const nodeOutputPre = document.getElementById('node-output-pre');
        
        const finalOutputArea = document.getElementById('final-output');
        const flippedHeadlineText = document.getElementById('flipped-headline-text');
        const dbSaveStatusText = document.getElementById('db-save-status-text');

        let currentGraphState = null;
        let cy = null; // Cytoscape instance

        // --- Helper Functions (escapeHtml, showUIMessage, hideUIMessages - unchanged) ---
        function escapeHtml(unsafe) {
            if (unsafe === null || typeof unsafe === 'undefined') return '';
            return unsafe.toString()
                .replace(/&/g, "&") // Corrected escapeHTML
                .replace(/</g, "<")
                .replace(/>/g, ">")
                .replace(/"/g, "\"")
                .replace(/'/g, "'");
        }
        function showUIMessage(element, text, type = 'error') { /* ... unchanged ... */ }
        function hideUIMessages() { /* ... unchanged ... */ }


        generateBtn.addEventListener('click', async () => {
            const headline = headlineInput.value.trim();
            if (!headline) { /* ... unchanged ... */ return; }

            hideUIMessages();
            loader.style.display = "block";
            generateBtn.disabled = true;
            graphVizArea.style.display = "none";
            nodeOutputPre.textContent = "{}";
            flippedHeadlineText.textContent = "Pending analysis...";
            dbSaveStatusText.textContent = "";
            
            if (cy) { // Destroy previous instance if exists
                cy.destroy();
                cy = null;
            }

            try {
                const response = await fetch('/.netlify/functions/generate-frames', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ headline })
                });
                const responseData = await response.json();
                if (!response.ok) { /* ... unchanged ... */ }
                
                if (responseData.error_summary || (responseData.graph_output && Object.values(responseData.graph_output).some(v => v && v.error))) {
                    showUIMessage(statusMessage, responseData.message || "Processing completed with some issues.", 'warning');
                } else {
                    showUIMessage(statusMessage, responseData.message || "Processing successful!", "success");
                }

                currentGraphState = responseData.graph_output;
                initializeAndDisplayGraph(currentGraphState); // New function for Cytoscape
                graphVizArea.style.display = "block";

            } catch (error) { /* ... unchanged ... */ }
            finally { /* ... unchanged ... */ }
        });

        function initializeAndDisplayGraph(graphData) {
            if (!graphData) return;

            // Define graph elements for Cytoscape
            // Your backend conceptual nodes: input, parallel_analyzers, synthesizer, saver
            // parallel_analyzers conceptually splits into analysis1 & analysis2
            const elements = [
                // Nodes
                { data: { id: 'input', label: 'Input Headline', stateKey: 'input_headline' } },
                { data: { id: 'analysis1', label: '1a. Detailed Analysis', stateKey: 'analysis1' } },
                { data: { id: 'analysis2', label: '1b. Simplified Analysis', stateKey: 'analysis2' } },
                { data: { id: 'synthesizer', label: '2. Synthesizer', stateKey: 'synthesizer' } },
                { data: { id: 'saver', label: '3. Save to DB', stateKey: 'saver' } },
                // Optional: A "start_parallel" node if you want to explicitly show the fork point before analysis1/2
                // { data: { id: 'start_parallel', label: 'Start Analyses', type: 'pseudo' } },

                // Edges (source and target are node IDs)
                // If using 'start_parallel':
                // { data: { id: 'edge_input_start', source: 'input', target: 'start_parallel', label: 'analyze' } },
                // { data: { id: 'edge_start_ana1', source: 'start_parallel', target: 'analysis1' } },
                // { data: { id: 'edge_start_ana2', source: 'start_parallel', target: 'analysis2' } },
                // { data: { id: 'edge_ana1_synth', source: 'analysis1', target: 'synthesizer' } },
                // { data: { id: 'edge_ana2_synth', source: 'analysis2', target: 'synthesizer' } },
                
                // Direct edges for simpler graph structure:
                { data: { id: 'edge_input_ana1', source: 'input', target: 'analysis1' } },
                { data: { id: 'edge_input_ana2', source: 'input', target: 'analysis2' } },
                { data: { id: 'edge_ana1_synth', source: 'analysis1', target: 'synthesizer' } },
                { data: { id: 'edge_ana2_synth', source: 'analysis2', target: 'synthesizer' } },
                { data: { id: 'edge_synth_saver', source: 'synthesizer', target: 'saver' } },
            ];

            cy = cytoscape({
                container: document.getElementById('cy-graph'),
                elements: elements,
                style: [ // Define styles for nodes and edges
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#e9ecef',
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'color': '#333',
                            'font-size': '10px',
                            'width': '80px', // Adjust for label length
                            'height': '40px',
                            'shape': 'round-rectangle', // or 'ellipse', 'rectangle'
                            'border-width': 1,
                            'border-color': '#ced4da',
                            'padding': '5px'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#adb5bd',
                            'target-arrow-color': '#adb5bd',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier' // or 'straight', 'haystack'
                        }
                    },
                    { // Style for selected node
                        selector: 'node:selected',
                        style: {
                            'border-width': 2,
                            'border-color': '#3498db'
                        }
                    },
                    { // Style for error nodes
                        selector: '.error-node',
                        style: {
                            'background-color': '#fcefee',
                            'border-color': '#e74c3c',
                            'border-width': 2
                        }
                    },
                    { // Style for success nodes
                        selector: '.success-node',
                        style: {
                            'background-color': '#e6f7f0',
                            'border-color': '#2ecc71',
                            'border-width': 2
                        }
                    }
                ],
                layout: {
                    name: 'dagre', // Use Dagre layout for DAGs
                    rankDir: 'TB', // Top-to-Bottom
                    spacingFactor: 1.2,
                    padding: 20
                }
            });

            // --- Update Node Styles based on graphData ---
            const nodeStatusMap = {
                'input': graphData.input_headline ? 'success' : 'error', // Input is always "success" if present
                'analysis1': graphData.analysis1_result?.error ? 'error' : (graphData.analysis1_result ? 'success' : null),
                'analysis2': graphData.analysis2_result?.error ? 'error' : (graphData.analysis2_result ? 'success' : null),
                'synthesizer': graphData.synthesis_result?.error ? 'error' : (graphData.synthesis_result ? 'success' : null),
                'saver': graphData.db_save_status && !graphData.db_save_status.success ? 'error' : (graphData.db_save_status?.success ? 'success' : null)
            };

            for (const [nodeId, status] of Object.entries(nodeStatusMap)) {
                if (status === 'success') {
                    cy.getElementById(nodeId).addClass('success-node');
                } else if (status === 'error') {
                    cy.getElementById(nodeId).addClass('error-node');
                }
            }

            // --- Handle Node Clicks ---
            cy.on('tap', 'node', function(evt){
                const node = evt.target;
                const stateKey = node.data('stateKey'); // Get the key we stored
                let detailsToShow = {};

                if (currentGraphState && stateKey) {
                    switch(stateKey) {
                        case 'input_headline':
                            detailsToShow = { input_headline: currentGraphState.input_headline };
                            break;
                        case 'analysis1':
                            detailsToShow = { analysis1_result: currentGraphState.analysis1_result };
                            break;
                        case 'analysis2':
                            detailsToShow = { analysis2_result: currentGraphState.analysis2_result };
                            break;
                        case 'synthesizer':
                            detailsToShow = { synthesis_result: currentGraphState.synthesis_result };
                            break;
                        case 'saver':
                            detailsToShow = { db_save_status: currentGraphState.db_save_status };
                            break;
                        default:
                            detailsToShow = { message: `Data for ${stateKey} not found in current state.` };
                    }
                    nodeOutputPre.textContent = JSON.stringify(detailsToShow, null, 2);
                    nodeDetailsContainer.querySelector('h3').textContent = `Details for: ${node.data('label')}`;
                }
            });
            
            // --- Display final outputs ---
            flippedHeadlineText.textContent = escapeHtml(graphData.flipped_headline || "N/A");
            if (graphData.db_save_status) {
                dbSaveStatusText.textContent = graphData.db_save_status.success 
                    ? `Database: Saved successfully.`
                    : `Database: Save failed. ${escapeHtml(graphData.db_save_status.message || '')}`;
                dbSaveStatusText.style.color = graphData.db_save_status.success ? 'green' : 'red';
            } else {
                dbSaveStatusText.textContent = "Database: Status N/A";
            }

            // Auto-select/tap the input node initially
            const inputNodeCy = cy.getElementById('input');
            if (inputNodeCy.length) { // Check if node exists
                inputNodeCy.trigger('tap');
                inputNodeCy.select(); // Visually select
            }
        }
    </script>
</body>
</html>