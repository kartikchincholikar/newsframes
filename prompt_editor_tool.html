<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangGraph Analyzer Editor</title>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.7.4/dist/dagre.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

    <style>
        /* ... (Your existing CSS) ... */
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background-color: #f0f2f5; overflow: hidden; }
        .top-bar { background-color: #333; color: white; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; }
        .top-bar input[type="file"] { display: none; }
        .top-bar label, .top-bar button { background-color: #555; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px; font-size: 14px; }
        .top-bar label:hover, .top-bar button:hover { background-color: #007bff; }
        .top-bar button#addAnalyzerButton { background-color: #2ecc71; margin-right: 15px; }
        .top-bar button#addAnalyzerButton:hover { background-color: #27ae60; }
        .main-content-area { display: flex; flex: 1; overflow: hidden; padding: 10px; gap: 10px; }
        #graph-section { width: 50%; display: flex; flex-direction: column; background-color: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        #cy { width: 100%; flex-grow: 1; border: 1px solid #ccc; border-radius: 8px; }
        #splitter { width: 10px; background-color: #e0e0e0; cursor: col-resize; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border-radius: 3px; }
        #splitter:hover { background-color: #c0c0c0; }
        #splitter::before { content: 'â‹®'; font-size: 16px; color: #777; line-height: 0; }
        #prompt-section { width: 50%; background-color: white; padding: 20px; overflow-y: auto; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        #prompt-section h2, #prompt-section h3, #prompt-section h4 { margin-top: 0; color: #333; }
        #prompt-section h4 { margin-top: 20px; margin-bottom: 10px; border-top: 1px dashed #eee; padding-top: 15px;}
        #prompt-section label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; color: #555; }
        #prompt-section textarea { width: calc(100% - 22px); min-height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 13px; margin-bottom: 10px; box-sizing: border-box; }
        #prompt-section input[type="text"] { width: calc(100% - 22px); padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; box-sizing: border-box; }
        .prompt-buttons { margin-top: 20px; display: flex; justify-content: space-between;}
        .delete-button { background-color: #e74c3c !important; }
        .delete-button:hover { background-color: #c0392b !important; }
        .info-text { color: #777; font-size: 0.9em; margin-bottom: 15px; }
        
        /* NEW: Styles for the new examples section */
        .examples-subsection { margin-top: 20px; border: 1px solid #e0e0e0; padding: 15px; border-radius: 6px; background-color: #f9f9f9;}
        .example-item { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dotted #ccc; }
        .example-item:last-child { border-bottom: none; }
        .example-item label { margin-top: 5px; font-size: 0.95em; }
        .example-item textarea { min-height: 60px; font-size: 12px; }
        .add-example-button { background-color: #5cb85c; color:white; border:none; padding: 8px 12px; border-radius:4px; cursor: pointer; margin-top:10px; }
        .add-example-button:hover { background-color: #4cae4c; }
        .remove-example-button { background-color: #d9534f; color:white; border:none; padding: 3px 8px; font-size:12px; border-radius:3px; cursor:pointer; float:right; }

    </style>
</head>
<body>
    <div class="top-bar">
        <h2>LangGraph Analyzer Editor</h2>
        <div>
            <input type="file" id="fileInput" accept=".json">
            <label for="fileInput">Load graph_config.json</label>
            <button id="addAnalyzerButton">Add New Analyzer Task</button>
            <button id="backupButton">Backup Current Config</button>
            <button id="saveButton">Save Updated Config</button>
        </div>
    </div>

    <div class="main-content-area">
        <div id="graph-section">
            <div id="cy"></div>
        </div>
        <div id="splitter"></div>
        <div id="prompt-section">
            <h2>Prompt Editor / Node Info</h2>
            <p class="info-text">Click on an Analyzer Task node to edit its properties.</p>
            <div id="editor-content">
                <!-- Form will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // --- (Unchanged variables and setup logic) ---
        const fileInput = document.getElementById('fileInput');
        const saveButton = document.getElementById('saveButton');
        const backupButton = document.getElementById('backupButton');
        const addAnalyzerButton = document.getElementById('addAnalyzerButton');
        
        const graphSection = document.getElementById('graph-section');
        const promptSection = document.getElementById('prompt-section');
        const editorContent = document.getElementById('editor-content');
        const promptSectionInfoText = promptSection.querySelector('.info-text');
        const splitter = document.getElementById('splitter');

        let cy;
        let currentGraphConfig = null;
        let selectedAnalyzerTaskId = null;
        const ANALYZER_COORDINATOR_ID = "parallel_analyzers_coordinator";
        const DATA_COLLECTOR_ID = "data_collector_for_saver";
        const analyzerColors = ['#8dd3c7', '#ffffb3', '#bebada', '#fb8072', '#80b1d3', '#fdb462', '#b3de69', '#fccde5', '#d9d9d9', '#bc80bd'];
        let colorIndex = 0;

        if (typeof dagre !== 'undefined' && typeof cytoscapeDagre !== 'undefined') {
            cytoscape.use(cytoscapeDagre);
        } else {
            console.error("Dagre libraries not loaded.");
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            showDefaultPromptEditorState();
            initSplitter();
        });

        fileInput.addEventListener('change', handleFileLoad);
        saveButton.addEventListener('click', handleSave);
        backupButton.addEventListener('click', handleBackup);
        addAnalyzerButton.addEventListener('click', handleAddAnalyzer);

        function showDefaultPromptEditorState(message = "Click on an Analyzer Task node (colored nodes within the 'Analyzer Group') to edit its properties, or add a new one.") {
            editorContent.innerHTML = '';
            if (promptSectionInfoText) {
                promptSectionInfoText.style.display = 'block';
                promptSectionInfoText.textContent = message;
            }
            promptSection.querySelector('h2').textContent = "Prompt Editor / Node Info";
            selectedAnalyzerTaskId = null;
        }

        function initSplitter() { /* ... unchanged ... */ 
            let isDragging = false, startX, startGraphWidth, startPromptWidth;
            splitter.addEventListener('mousedown', function(e) {
                isDragging = true; startX = e.clientX; startGraphWidth = graphSection.offsetWidth; startPromptWidth = promptSection.offsetWidth;
                document.body.style.cursor = 'col-resize'; document.body.style.userSelect = 'none';
            });
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                graphSection.style.width = `${startGraphWidth + dx}px`;
                promptSection.style.width = `${startPromptWidth - dx}px`;
                if(cy) cy.resize();
            });
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false; document.body.style.cursor = 'default'; document.body.style.userSelect = 'auto';
                    if (cy) { cy.resize(); cy.layout({ name: 'dagre', rankDir: 'TB', spacingFactor: 1.1, nodeSep: 50, fit: true, padding: 30 }).run(); }
                }
            });
        }
        function handleFileLoad(event) { /* ... unchanged ... */
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    currentGraphConfig = JSON.parse(e.target.result);
                    initializeCytoscape(currentGraphConfig);
                    showDefaultPromptEditorState();
                } catch (err) { alert("Error parsing JSON file: " + err.message); }
            };
            reader.readAsText(file);
        }
        function handleBackup() { /* ... unchanged ... */ 
            if (!currentGraphConfig) { alert("No config loaded."); return; }
            downloadJSON(currentGraphConfig, `graph_config_backup_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.json`);
        }
        function handleSave() { // MODIFIED: Always save changes from form before download
            if (!currentGraphConfig) { alert("No config loaded."); return; }
            if (selectedAnalyzerTaskId) { 
                if (!savePromptChangesToConfig(selectedAnalyzerTaskId, true)) { // Pass silent=true
                    return; // Stop if save fails due to invalid JSON
                }; 
            }
            downloadJSON(currentGraphConfig, 'graph_config_updated.json');
        }
        function downloadJSON(data, filename) { /* ... unchanged ... */ 
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function initializeCytoscape(config) { /* ... unchanged ... */
            const elements = []; colorIndex = 0;
            const coordinatorNodeDef = config.nodeDefinitions.find(n => n.id === ANALYZER_COORDINATOR_ID);
            config.nodeDefinitions.forEach(nodeDef => elements.push({ data: { id: nodeDef.id, label: nodeDef.displayName, type: nodeDef.type }}));
            if (coordinatorNodeDef && coordinatorNodeDef.analyzerTasks) {
                coordinatorNodeDef.analyzerTasks.forEach(task => {
                    const taskColor = analyzerColors[colorIndex++ % analyzerColors.length];
                    elements.push({ data: { id: task.id, label: task.displayName, parent: ANALYZER_COORDINATOR_ID, type: 'analyzer_task', color: taskColor }});
                });
            }
            if (config.graphEdges.some(edge => edge.target === 'END')) elements.push({ data: { id: 'END', label: 'END' }});
            config.graphEdges.forEach(edge => elements.push({ data: { id: `${edge.source}_to_${edge.target}`, source: edge.source, target: edge.target }}));
            if (cy) cy.destroy();
            cy = cytoscape({
                container: document.getElementById('cy'), elements,
                style: [ { selector: 'node', style: { 'label': 'data(label)', 'text-valign': 'center', 'text-wrap': 'wrap', 'text-max-width': '90px', 'background-color': '#e8e8e8', 'shape': 'round-rectangle'}}, { selector: 'edge', style: { 'width': 1.5, 'line-color': '#ccc', 'target-arrow-color': '#ccc', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier' } }, { selector: 'node[type="analyzer_task"]', style: { 'background-color': 'data(color)', 'border-color': 'black', 'font-weight': 'bold', 'font-size': '12px' } }, { selector: `node[parent="${ANALYZER_COORDINATOR_ID}"]`, style: {'font-size': '11px', 'width': '100px', 'height': '50px'}}, { selector: `#${ANALYZER_COORDINATOR_ID}`, style: { 'background-color': 'rgba(230, 240, 255, 0.7)', 'shape': 'rectangle', 'border-color': '#a0c0e0', 'border-width': 2, 'label': 'Analyzer Group (Parallel)', 'padding': '25px', 'text-valign': 'top', 'font-weight': 'bold', 'color': '#4682b4' } }, { selector: '#END', style: { 'background-color': '#a9a9a9', 'shape': 'ellipse', 'width': '70px', 'height': '40px' } }, { selector: 'node:selected', style: { 'border-width': 3, 'border-color': '#0056b3' } }],
                layout: { name: 'dagre', rankDir: 'TB', spacingFactor: 1.2, nodeSep: 60, rankSep: 80, fit: true, padding: 30 }
            });
            cy.on('tap', 'node', function(event){ /* ... unchanged event handler logic ... */
                const clickedNode = event.target; const nodeId = clickedNode.id(); const nodeType = clickedNode.data('type');
                cy.nodes().deselect(); clickedNode.select();
                if (nodeType === 'analyzer_task') { selectedAnalyzerTaskId = nodeId; populatePromptEditor(nodeId); }
                else { showDefaultPromptEditorState(`Selected Node: ${clickedNode.data('label')}. Only Analyzer Task nodes can be edited with the form.`);}
            });
        }
        function findNodeDefinition(nodeId) { return currentGraphConfig.nodeDefinitions.find(n => n.id === nodeId); }
        function findAnalyzerTask(taskId) { const coordinator = findNodeDefinition(ANALYZER_COORDINATOR_ID); return coordinator ? coordinator.analyzerTasks.find(task => task.id === taskId) : null; }

        // NEW: --- FUNCTIONS FOR PARSING AND RECONSTRUCTING EXAMPLES ---
        const EXAMPLE_BLOCK_REGEX = /^\s*### Examples:\s*([\s\S]*?)(?=\n###|\n\n\w|$)/im;
        const SINGLE_EXAMPLE_REGEX = /\*\*Example \d+.*?\*\*[\s\S]*?Input:[\s\n]*?"?([\s\S]*?)"?[\s\n]+Output:\s*```json\s*([\s\S]*?)\s*```/gi;
        const EXAMPLES_HEADER = "### Examples:";

        function parseExamplesFromDevInstructions(devInstructions) {
            const examples = [];
            if (typeof devInstructions !== 'string') return examples;

            // OLD, TOO STRICT REGEX:
            // const SINGLE_EXAMPLE_REGEX = /\*\*Example \d+.*?\*\*[\s\S]*?Input:[\s\n]*?"?([\s\S]*?)"?[\s\n]+Output:\s*```json\s*([\s\S]*?)\s*```/gi;

            // NEW, MORE FLEXIBLE REGEX:
            // This regex looks for the "Example...Input...Output" keywords and captures the input text and the subsequent raw JSON block {}.
            const FLEXIBLE_EXAMPLE_REGEX = /Example.*?:[\s\n]*?Input:\s*"?([\s\S]*?)"?[\s\n]*?Output:\s*({[\s\S]*?})(?=\n\nExample|$)/gi;

            let match;
            // We use the new regex here.
            while ((match = FLEXIBLE_EXAMPLE_REGEX.exec(devInstructions)) !== null) {
                try {
                    // match[1] is the captured Input text.
                    // match[2] is the captured Output JSON string.
                    const input = match[1].trim().replace(/^"|"$/g, ''); // Clean up quotes
                    const outputJson = JSON.parse(match[2].trim());
                    examples.push({ input, output: outputJson });
                } catch (e) {
                    console.warn("Failed to parse an example JSON block with the new regex:", e, match[2]);
                }
            }
            
            // If the new regex found nothing, try the original one for backwards compatibility
            // in case some examples are already in the new, structured format.
            if (examples.length === 0) {
                const ORIGINAL_EXAMPLE_REGEX = /\*\*Example \d+.*?\*\*[\s\S]*?Input:[\s\n]*?"?([\s\S]*?)"?[\s\n]+Output:\s*```json\s*([\s\S]*?)\s*```/gi;
                while ((match = ORIGINAL_EXAMPLE_REGEX.exec(devInstructions)) !== null) {
                    try {
                        const input = match[1].trim().replace(/^"|"$/g, '');
                        const outputJson = JSON.parse(match[2].trim());
                        examples.push({ input, output: outputJson });
                    } catch (e) {
                        console.warn("Failed to parse an example JSON block with the original regex:", e, match[2]);
                    }
                }
            }

            return examples;
        }

        function renderExamplesUI(examples, containerElement, taskId) {
            containerElement.innerHTML = '<h4>Editable Examples:</h4>';
            if (examples.length === 0) {
                containerElement.innerHTML += '<p>No examples found or parsed. You can add one below.</p>';
            }
            examples.forEach((ex, index) => {
                const exampleDiv = document.createElement('div');
                exampleDiv.className = 'example-item';
                exampleDiv.dataset.exampleIndex = index;
                exampleDiv.innerHTML = `
                    <label for="ex-input-${index}-${taskId}">Example ${index + 1} Input: <button type="button" class="remove-example-button" onclick="removeExample(${index}, '${taskId}')">Remove</button></label>
                    <textarea id="ex-input-${index}-${taskId}">${ex.input}</textarea>
                    <label for="ex-output-${index}-${taskId}">Example ${index + 1} Output (JSON):</label>
                    <textarea id="ex-output-${index}-${taskId}" class="example-output-json">${JSON.stringify(ex.output, null, 2)}</textarea>
                `;
                containerElement.appendChild(exampleDiv);
            });
            const addExampleBtn = document.createElement('button');
            addExampleBtn.textContent = 'Add Another Example';
            addExampleBtn.className = 'add-example-button';
            addExampleBtn.type = 'button';
            addExampleBtn.onclick = () => addNewExampleUI(containerElement, taskId);
            containerElement.appendChild(addExampleBtn);
        }
        
        window.removeExample = function(index, taskId) {
            const examplesContainer = document.getElementById(`examples-subsection-${taskId}`);
            const exampleItemToRemove = examplesContainer.querySelector(`.example-item[data-example-index="${index}"]`);
            if(exampleItemToRemove) {
                exampleItemToRemove.remove();
                // Re-index remaining examples
                const remainingItems = examplesContainer.querySelectorAll('.example-item');
                remainingItems.forEach((item, newIndex) => {
                    item.dataset.exampleIndex = newIndex;
                    const label = item.querySelector('label[for^="ex-input"]');
                    label.innerHTML = `Example ${newIndex + 1} Input: <button type="button" class="remove-example-button" onclick="removeExample(${newIndex}, '${taskId}')">Remove</button>`;
                    item.querySelector('label[for^="ex-output"]').textContent = `Example ${newIndex + 1} Output (JSON):`;
                    item.querySelector('textarea[id^="ex-input"]').id = `ex-input-${newIndex}-${taskId}`;
                    item.querySelector('textarea[id^="ex-output"]').id = `ex-output-${newIndex}-${taskId}`;
                });
            }
        }

        function addNewExampleUI(containerElement, taskId) {
            const examples = getEditedExamplesFromUI(taskId, true); // Get current examples from UI, silent on errors
            const newIndex = examples.length;
            const exampleDiv = document.createElement('div');
            exampleDiv.className = 'example-item';
            exampleDiv.dataset.exampleIndex = newIndex;
            exampleDiv.innerHTML = `
                <label for="ex-input-${newIndex}-${taskId}">Example ${newIndex + 1} Input: <button type="button" class="remove-example-button" onclick="removeExample(${newIndex}, '${taskId}')">Remove</button></label>
                <textarea id="ex-input-${newIndex}-${taskId}" placeholder="Enter example input text..."></textarea>
                <label for="ex-output-${newIndex}-${taskId}">Example ${newIndex + 1} Output (JSON):</label>
                <textarea id="ex-output-${newIndex}-${taskId}" class="example-output-json" placeholder="Enter valid JSON output...">${JSON.stringify({ analyzer_alternative_headline_with_placeholders: "New example placeholder" }, null, 2)}</textarea>
            `;
            containerElement.insertBefore(exampleDiv, containerElement.querySelector('.add-example-button'));
        }

        function getEditedExamplesFromUI(taskId, silent = false) {
            const editedExamples = [];
            const exampleItems = document.querySelectorAll(`#examples-subsection-${taskId} .example-item`);
            let hasError = false;
            exampleItems.forEach((item, index) => {
                const inputEl = item.querySelector(`textarea[id^="ex-input-"]`);
                const outputEl = item.querySelector(`textarea[id^="ex-output-"]`);
                if (inputEl && outputEl) {
                    try {
                        const outputJson = JSON.parse(outputEl.value);
                        editedExamples.push({ input: inputEl.value.trim(), output: outputJson });
                        outputEl.style.borderColor = '#ddd'; // Reset border on success
                    } catch (e) {
                        if (!silent) {
                            alert(`Error parsing JSON for Example ${index + 1}: ${e.message}. Please fix the JSON before saving.`);
                            outputEl.style.borderColor = 'red';
                            outputEl.focus();
                        }
                        hasError = true;
                    }
                }
            });
            return hasError ? null : editedExamples;
        }

        function reconstructDevInstructions(instructionsText, editedExamples) {
            let examplesString = "";
            if (editedExamples.length > 0) {
                examplesString = EXAMPLES_HEADER + "\n\n";
                editedExamples.forEach((ex, index) => {
                    const outputStr = JSON.stringify(ex.output, null, 2);
                    examplesString += `**Example ${index + 1}:**\nInput: "${ex.input}"\nOutput:\n\`\`\`json\n${outputStr}\n\`\`\`\n\n`;
                });
            }
            return (instructionsText.trim() + "\n\n" + examplesString.trim()).trim();
        }

        // MODIFIED: This function now drives the new UI
        function populatePromptEditor(taskId) {
            const task = findAnalyzerTask(taskId);
            if (!task) {
                editorContent.innerHTML = "<p>Error: Analyzer task object not found.</p>"; return;
            }
            selectedAnalyzerTaskId = taskId;
            if (promptSectionInfoText) promptSectionInfoText.style.display = 'none';
            promptSection.querySelector('h2').textContent = `Edit Analyzer: ${task.displayName}`;

            const devInstructions = task.promptConfig.developerInstructionsTemplate || '';
            const parsedExamples = parseExamplesFromDevInstructions(devInstructions);
            
            let mainDevInstructionsText = devInstructions.replace(EXAMPLE_BLOCK_REGEX, '').trim();

            editorContent.innerHTML = `
                <h3>${task.displayName}</h3>
                <div><label for="edit-displayName-${taskId}">Display Name:</label><input type="text" id="edit-displayName-${taskId}" value="${task.displayName}"></div>
                <div><label for="edit-stateOutputKey-${taskId}">State Output Key:</label><input type="text" id="edit-stateOutputKey-${taskId}" value="${task.stateOutputKey || ''}" readonly></div>
                <hr><h4>Prompt Configuration:</h4>
                <div><label for="edit-systemMessage-${taskId}">System Message:</label><textarea id="edit-systemMessage-${taskId}">${task.promptConfig.systemMessage || ''}</textarea></div>
                <div><label for="edit-devInstructionsText-${taskId}">Developer Instructions (excluding examples):</label><textarea id="edit-devInstructionsText-${taskId}" style="min-height: 150px;">${mainDevInstructionsText}</textarea></div>
                <div class="examples-subsection" id="examples-subsection-${taskId}"></div>
                <div><label for="edit-userInput-${taskId}">User Input Template:</label><textarea id="edit-userInput-${taskId}">${task.promptConfig.userInputTemplate || ''}</textarea></div>
                <div class="prompt-buttons">
                    <button onclick="savePromptChangesToConfig('${taskId}')">Update Task in Config</button>
                    <button class="delete-button" onclick="handleDeleteAnalyzer('${taskId}')">Delete This Analyzer Task</button>
                </div>
            `;
            renderExamplesUI(parsedExamples, document.getElementById(`examples-subsection-${taskId}`), taskId);
         }

        // MODIFIED: This function now uses the reconstruction logic
        window.savePromptChangesToConfig = function(taskId, silent = false) {
            if (!currentGraphConfig || !taskId) return false;
            const taskToUpdate = findAnalyzerTask(taskId);
            if (!taskToUpdate) { if (!silent) alert("Error: Task not found."); return false; }
            
            // Get edited examples first to validate JSON
            const editedExamples = getEditedExamplesFromUI(taskId, silent);
            if (editedExamples === null) {
                return false; // Error was already shown to user
            }

            taskToUpdate.displayName = document.getElementById(`edit-displayName-${taskId}`).value;
            if (!taskToUpdate.promptConfig) taskToUpdate.promptConfig = {}; 
            taskToUpdate.promptConfig.systemMessage = document.getElementById(`edit-systemMessage-${taskId}`).value;
            const devInstructionsTextOnly = document.getElementById(`edit-devInstructionsText-${taskId}`).value;
            taskToUpdate.promptConfig.developerInstructionsTemplate = reconstructDevInstructions(devInstructionsTextOnly, editedExamples);
            taskToUpdate.promptConfig.userInputTemplate = document.getElementById(`edit-userInput-${taskId}`).value;
            
            if (!silent) alert(`Changes for '${taskToUpdate.displayName}' captured. Click "Save Updated Config" to download.`);
            
            const cyNode = cy.getElementById(taskId);
            if (cyNode && cyNode.length > 0) cyNode.data('label', taskToUpdate.displayName);
            return true; // Success
        };
        
        // --- (Unchanged Add/Delete/Default prompt logic) ---
        const defaultNewAnalyzerPromptConfig = {
            systemMessage: "You are an AI assistant. Your task is to analyze the provided headline based on a specific framing perspective and then rewrite it. Output ONLY valid JSON as specified.",
            developerInstructionsTemplate: `Instruction:\n1. Analyze the input headline: "{{headlineToAnalyze}}".\n2. Identify [SPECIFIC FRAMING ASPECT - e.g., emotional sentiment, implied bias, etc.].\n3. Based on this, rewrite the headline to [SPECIFIC GOAL - e.g., neutralize sentiment, highlight bias, offer counter-narrative]. Retain placeholders.\n4. If no significant [SPECIFIC FRAMING ASPECT] is found or a meaningful rewrite cannot be generated, \`analyzer_alternative_headline_with_placeholders\` should be "No relevant aspect found for this type of reframing.".\n5. Your entire output MUST be a single, valid JSON object.\n\nRequired JSON Output Schema:\n{\n  "input_headline": "{{headlineToAnalyze}}",\n  "analysis_summary": "string (Brief summary of your findings regarding [SPECIFIC FRAMING ASPECT])",\n  "analyzer_alternative_headline_with_placeholders": "string (The rewritten headline, or 'No relevant aspect found for this type of reframing.')"\n}\n\n### Examples:\n\n**Example 1:**\nInput: "Default example input for new analyzer."\nOutput:\n\`\`\`json\n{\n  "input_headline": "Default example input for new analyzer.",\n  "analysis_summary": "Initial analysis based on [SPECIFIC FRAMING ASPECT].",\n  "analyzer_alternative_headline_with_placeholders": "Rewritten headline based on [SPECIFIC GOAL]."\n}\n\`\`\``,
            userInputTemplate: "Analyze and reframe this headline based on [YOUR NEW ANALYSIS TYPE]: \"{{headlineToAnalyze}}\""
        };
        function generateNewAnalyzerId(baseName = "new_analyzer_task") { /* ... unchanged ... */ 
            let i = 1; let newId = `${baseName}_${i}`;
            const coordinator = findNodeDefinition(ANALYZER_COORDINATOR_ID);
            if (!coordinator || !coordinator.analyzerTasks) return newId; 
            const existingIds = new Set(coordinator.analyzerTasks.map(task => task.id));
            while (existingIds.has(newId)) newId = `${baseName}_${++i}`;
            return newId;
        }
        function handleAddAnalyzer() { /* ... unchanged ... */
            if (!currentGraphConfig) { alert("Load a graph_config.json file first."); return; }
            const coordinator = findNodeDefinition(ANALYZER_COORDINATOR_ID);
            if (!coordinator) { alert("Error: parallel_analyzers_coordinator not found."); return; }
            const newIdBase = prompt("Enter a short base name for the new analyzer (e.g., sentiment_analyzer):", "new_task");
            if (!newIdBase || !newIdBase.trim()) return;
            const newAnalyzerId = generateNewAnalyzerId(newIdBase.trim().toLowerCase().replace(/\s+/g, '_'));
            const newReverterId = `${newAnalyzerId}_reverter`;
            const newRevertedStateKey = `${newAnalyzerId}_reverted_headline`;
            if (!coordinator.analyzerTasks) coordinator.analyzerTasks = [];
            coordinator.analyzerTasks.push({ id: newAnalyzerId, displayName: `X. ${newIdBase.trim()}`, stateOutputKey: `${newAnalyzerId}_result`, promptConfig: JSON.parse(JSON.stringify(defaultNewAnalyzerPromptConfig)) });
            currentGraphConfig.nodeDefinitions.push({ id: newReverterId, displayName: `Revert: ${newIdBase.trim()}`, type: "local_function", functionName: "revertGenericAnalyzerHeadline", stateInputArgs: { analyzer_result_object: `${newAnalyzerId}_result`, "properNoun_map": "properNoun_map" }, stateOutputKey: newRevertedStateKey });
            currentGraphConfig.graphEdges.push({ source: ANALYZER_COORDINATOR_ID, target: newReverterId });
            currentGraphConfig.graphEdges.push({ source: newReverterId, target: DATA_COLLECTOR_ID });
            const collectorNode = findNodeDefinition(DATA_COLLECTOR_ID);
            if (collectorNode && collectorNode.stateInputArgs) collectorNode.stateInputArgs[`${newAnalyzerId}_reverted_headline_to_save`] = newRevertedStateKey;
            initializeCytoscape(currentGraphConfig);
            const taskNodeInCy = cy.getElementById(newAnalyzerId); if(taskNodeInCy) taskNodeInCy.trigger('tap');
        }
        window.handleDeleteAnalyzer = function(taskIdToDelete) { /* ... unchanged ... */
            if (!currentGraphConfig || !taskIdToDelete) return; if (!confirm(`Delete "${taskIdToDelete}"?`)) return;
            const coordinator = findNodeDefinition(ANALYZER_COORDINATOR_ID); if (!coordinator) return;
            const taskIndex = coordinator.analyzerTasks.findIndex(task => task.id === taskIdToDelete); if(taskIndex === -1) return;
            const reverterIdToDelete = `${taskIdToDelete}_reverter`;
            coordinator.analyzerTasks.splice(taskIndex, 1);
            currentGraphConfig.nodeDefinitions = currentGraphConfig.nodeDefinitions.filter(n => n.id !== reverterIdToDelete);
            currentGraphConfig.graphEdges = currentGraphConfig.graphEdges.filter(edge => edge.source !== reverterIdToDelete && edge.target !== reverterIdToDelete);
            const collectorNode = findNodeDefinition(DATA_COLLECTOR_ID);
            if (collectorNode && collectorNode.stateInputArgs) Object.keys(collectorNode.stateInputArgs).forEach(k => { if (collectorNode.stateInputArgs[k] === `${taskIdToDelete}_reverted_headline`) delete collectorNode.stateInputArgs[k]; });
            initializeCytoscape(currentGraphConfig); showDefaultPromptEditorState();
        };

    </script>
</body>
</html>